NeuroManageAI - SDR Instagram

Esta documentacao explica todo o fluxo em ordem de execucao, detalhando o papel tecnico de cada node e por que cada etapa existe no contexto de atendimento SDR no Instagram (comentarios, DM e resposta automatizada com IA).

====================================================================
1) OBJETIVO DO FLUXO
====================================================================

Objetivo macro:

Receber eventos do Instagram via webhook, identificar tipo de mensagem (texto, reacao, audio, imagem), acumular contexto em buffer Redis, gerar resposta com agente de IA, enviar de volta ao canal e registrar estado/conversa para continuidade.

Em termos praticos, o fluxo faz:
1. Recebe evento no endpoint webhook `insta`.
2. Normaliza dados do lead (ids, mensagem, comentario, conta).
3. Filtra mensagens para nao responder a propria conta.
4. Roteia tipo de mensagem em `Rotas de Mensagens`.
5. Converte/transcreve audio e imagem para texto quando necessario.
6. Empilha entradas no Redis por conversa (`_buffer`).
7. Aguarda janela de buffer e compara ultima mensagem para evitar resposta prematura.
8. Consolida contexto em `Mensagem1`.
9. Busca ou cria lead no Supabase (`usuariosInstagram`).
10. Executa agente principal (`NMAI Agent`) + parser estruturado para retornar blocos de resposta.
11. Faz loop de mensagens, resolve `chat_id` e envia texto pela API da Unipile.
12. Espera (`Wait3`) e retorna ao loop de envios.

====================================================================
2) TABELA SQL ENVOLVIDA
====================================================================

SQL fornecido no diretorio:
- public.follow_up

Tabela efetivamente usada no JSON:
- usuariosInstagram (Supabase nodes `Encontrar Cliente1` e `Criar Cliente1`)

Leitura tecnica importante:
- O arquivo `.sql` nao representa a tabela usada neste fluxo especifico.
- Se a intencao for documentar este fluxo de Instagram, a DDL correta deveria ser da tabela `usuariosInstagram`.
- `follow_up` parece ser schema reaproveitado do fluxo de cadencia, nao do SDR Instagram.

====================================================================
3) SEQUENCIA EXECUTIVA COMPLETA (ALTO NIVEL)
====================================================================

Webhook1 (POST /insta)
-> Parametros Fluxo
-> Dados Lead
-> Filtro Inicial (ignora mensagens da propria conta)
-> Redis (status do bot)
-> Bot Desativado?1
   -> desativado: No Operation, do nothing
   -> ativo: Rotas de Mensagens
      -> Texto1/Texto2 -> Add Texto Buffer1
      -> Audio -> Converso de Audio -> Transcrever Audio -> Add Audio Buffer1
      -> Imagem -> Converso Imagem -> Analisar Imagem -> Add Imagem Buffer1
      -> Outro/Erro -> Mensagem Erro -> Add Erro Buffer1
-> Buffer -> Wait1 -> Buffer 3 -> ComparandoMensagens1
   -> igual: Apagar Buffer1 -> Mensagem1
   -> diferente: No Operation, do nothing6
-> Encontrar Cliente1 -> Cliente Existe?1
   -> existe: Merge
   -> nao existe: Criar Cliente1 -> Merge
-> NMAI Agent -> Basic LLM Chain (output estruturado)
-> Split Out1 -> Loop Over Items1
   -> por item: chat_id -> HTTP Request1 (envio) -> Wait3 -> Loop Over Items1
   -> fim: No Operation, do nothing5

Ramo paralelo de comentario:
Comentario -> Filtro Comentario -> Tempo de Resposta -> AI Agent -> HTTP Request2 (reply no comentario IG) -> No Operation, do nothing1

====================================================================
4) NODE POR NODE (DETALHAMENTO COM CONTEXTO)
====================================================================

--------------------------------------------------
ETAPA 1 - Webhook1
Tipo: n8n-nodes-base.webhook
--------------------------------------------------
Configuracao:
- Metodo POST
- Path: insta

O que faz:
- Recebe payload do Instagram e inicia o fluxo.


--------------------------------------------------
ETAPA 2 - Parametros Fluxo / Dados Lead
Tipo: n8n-nodes-base.set
--------------------------------------------------
Parametros Fluxo define:
- EsperaBuffer = 20
- TempoInatividadeAgente = 3600
- ModeloTemperatura = 0.4

Dados Lead extrai:
- IdConversa
- account_id
- sender_id
- recipient_id
- message_text
- from_id
- comment_id

Objetivo:
- Padronizar variaveis para os demais nodes.


--------------------------------------------------
ETAPA 3 - Filtro Inicial / Filtro Comentario
Tipo: n8n-nodes-base.filter
--------------------------------------------------
O que faz:
- Evita autoreply para mensagens da propria conta (`sender_id != account_id`).
- No ramo de comentarios, valida relacao `account_id` x `from_id`.

Objetivo:
- Reduzir loops e respostas indevidas.


--------------------------------------------------
ETAPA 4 - Rotas de Mensagens
Tipo: n8n-nodes-base.switch
--------------------------------------------------
Saidas mapeadas:
- Texto1 (conversation)
- Texto2 (reactionMessage)
- Audio (audioMessage)
- Imagem (imageMessage)
- Outro (fallback)

Objetivo:
- Direcionar cada tipo de entrada para o tratamento correto.


--------------------------------------------------
ETAPA 5 - Tratamento multimidia
Tipo: set + conversao + IA
--------------------------------------------------
Audio:
- Mensagem Audio -> Converso de Audio -> Transcrever Audio -> Add Audio Buffer1

Imagem:
- Mensagem Imagem -> Converso Imagem -> Analisar Imagem -> Add Imagem Buffer1

Texto:
- Mensagem Texto1/2 -> Add Texto Buffer1

Erro/Fallback:
- Mensagem Erro -> Add Erro Buffer1

Objetivo:
- Transformar entradas diferentes em texto para contexto unificado.


--------------------------------------------------
ETAPA 6 - Bufferizacao e controle de concorrencia
Tipo: Redis + Wait + If
--------------------------------------------------
Nodes:
- Buffer (get lista)
- Wait1
- Buffer 3 (get lista apos espera)
- ComparandoMensagens1 (compara ultima msg antes/depois)
- Apagar Buffer1 (delete key)
- Mensagem1 (join de mensagens do buffer)

Objetivo:
- Agrupar mensagens proximas no tempo e responder com contexto consolidado.


--------------------------------------------------
ETAPA 7 - Lead lookup/create (Supabase)
Tipo: n8n-nodes-base.supabase
--------------------------------------------------
Nodes:
- Encontrar Cliente1 (get em `usuariosInstagram` por `sender_id`)
- Cliente Existe?1
- Criar Cliente1 (insere sender_id quando nao existe)
- Merge

Objetivo:
- Garantir persistencia e identificacao do contato no Supabase.


--------------------------------------------------
ETAPA 8 - Agentes de IA
Tipo: LangChain (agent, chain, memory, parser)
--------------------------------------------------
Nodes principais:
- NMAI Agent (agente SDR principal com prompt extenso)
- OpenAI Chat Model2 (gpt-4.1-mini)
- Postgres Chat Memory (memoria por IdConversa)
- DesativarAgente1 (tool redis para handoff humano)
- Basic LLM Chain (formata output)
- Structured Output Parser [Schema] + Auto-fixing Output Parser1

Objetivo:
- Gerar resposta contextual, em multiplos blocos curtos, com memoria de conversa.


--------------------------------------------------
ETAPA 9 - Envio de resposta
Tipo: Split/Loop + HTTP Request
--------------------------------------------------
Nodes:
- Split Out1 (quebra array `mensagens`)
- Loop Over Items1
- chat_id (consulta chat)
- HTTP Request1 (POST envio da mensagem na Unipile)
- Wait3 (pausa entre envios)

Endpoint usado:
- https://api23.unipile.com:15389/api/v1/chats/{{chat_id}}/messages

Headers:
- X-API-KEY
- accept: application/json


--------------------------------------------------
ETAPA 10 - Ramo de resposta a comentario Instagram
Tipo: AI Agent + HTTP Request2
--------------------------------------------------
Nodes:
- Comentario
- Filtro Comentario
- Tempo de Resposta (espera aleatoria 5-10 min)
- AI Agent
- HTTP Request2 (Graph API replies)

Endpoint:
- https://graph.instagram.com/v22.0/{id}/replies

Body:
- ig.comment.id
- message

Objetivo:
- Responder comentarios publicos de forma automatica.

====================================================================
5) PONTOS DE ATENCAO / RISCOS TECNICOS
====================================================================

1. Inconsistencia SQL x JSON
   - SQL no diretorio cria `follow_up`, mas workflow usa `usuariosInstagram`.

2. Segredos hardcoded em HTTP nodes
   - `X-API-KEY` aparece diretamente no JSON (Unipile). Recomendado mover para credenciais/variaveis seguras.

3. Dependencia de estrutura de payload
   - Expressoes usam caminhos profundos (`entry[0].changes[0]...`). Mudanca no webhook quebra fluxo.

4. Duplicidade de trilhas
   - Existem dois agentes (AI Agent e NMAI Agent) com prop√≥sitos diferentes; manter documentado evita confusao na manutencao.

5. Buffer e timing
   - A logica `Wait1 + ComparandoMensagens1` depende do comportamento do Redis; ajustar tempos conforme volume.

6. Node legado/referencia externa
   - `Mensagem Texto2` referencia `$('Webhook')` (nome diferente de `Webhook1`) em trecho especifico; revisar no n8n para evitar erro de referencia.

====================================================================
6) RESUMO FINAL
====================================================================

O fluxo NeuroManageAI - SDR Instagram e um pipeline completo de atendimento automatizado para Instagram: recebe eventos, normaliza dados, roteia por tipo de mensagem, acumula contexto via Redis, identifica/cria lead no Supabase, gera resposta com IA e envia por API. A principal pendencia estrutural e alinhar a documentacao SQL com a tabela realmente utilizada (`usuariosInstagram`) e remover segredos hardcoded dos HTTP Requests.
